<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vehicle Performance Calculation System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Roboto', 'sans-serif'],
            display: ['Oswald', 'sans-serif'],
          },
          colors: {
            // Industrial Grays
            page: '#f0f2f5', 
            surface: '#ffffff',
            dark: '#212529',
            brand: '#1d4ed8',
          },
        }
      }
    }
  </script>

  <style>
    /* Watermark Number Effect */
    .watermark-text::before {
        content: attr(data-index);
        position: absolute;
        top: -15px;
        right: 10px;
        font-family: 'Oswald', sans-serif;
        font-size: 6rem;
        font-weight: 700;
        color: #f3f4f6;
        z-index: -1;
        transition: all 0.3s;
        opacity: 0.6;
    }
    .group:hover .watermark-text::before {
        transform: translateY(5px);
        color: #e9ecef;
    }
    
    /* Match hydraulic calculator input styles */
    .input-field,
    .input {
        background: #f9fafb;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.5rem 0.6rem;
        width: 100%;
        transition: all 0.15s;
        font-size: 0.875rem;
    }
    .dark .input-field,
    .dark .input {
        background: #1f2937;
        border-color: #374151;
        color: #e6eef8;
    }
    .input-field:focus,
    .input:focus {
        outline: none;
        box-shadow: 0 0 0 4px rgba(29,78,216,0.12);
        border-color: #1d4ed8;
    }
    .input-field:disabled,
    .input:disabled {
        background: #e5e7eb;
        cursor: not-allowed;
        opacity: 0.6;
    }
    .dark .input-field:disabled,
    .dark .input:disabled {
        background: #374151;
        border-color: #4b5563;
    }
    
    /* Toast Notifications */
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
    .toast { padding: 14px 20px; border-radius: 8px; color: white; font-weight: 500; animation: slideIn 0.3s ease; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-width: 350px; }
    .toast.success { background: linear-gradient(135deg, #10b981, #059669); }
    .toast.error { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .toast.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .toast.info { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
  </style>

  <script>
    // --- AUTH LOGIC ---
    const DEFAULT_AVATAR = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiM2MzY2RjEiLz4KPHBhdGggZD0iTTE2IDE2QzE4LjIwOTEgMTYgMjAgMTQuMjA5MSAyMCAxMkMxOCA3Ljc5MDkgMTYgMTYuMDAwMSAxNi4wMDAxQzEzLjc5MDkgMTYuMDAwMSAxMiAxOC4yMDkxIDEyIDIwQzEyIDIyLjIwOTEgMTMuNzkgMjQgMTYgMjRaIiBmaWxsPSIjRkZGRkZGRiIvPgo8L3N2Zz4K";

    document.addEventListener("DOMContentLoaded", function() {
      // Dark mode initialization
      const theme = localStorage.getItem('theme') || 'light';
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
        document.getElementById('sun-icon').classList.add('hidden');
        document.getElementById('moon-icon').classList.remove('hidden');
      }

      // Theme toggle
      document.getElementById('theme-toggle').addEventListener('click', function() {
        const html = document.documentElement;
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        
        if (html.classList.contains('dark')) {
          html.classList.remove('dark');
          localStorage.setItem('theme', 'light');
          sunIcon.classList.remove('hidden');
          moonIcon.classList.add('hidden');
        } else {
          html.classList.add('dark');
          localStorage.setItem('theme', 'dark');
          sunIcon.classList.add('hidden');
          moonIcon.classList.remove('hidden');
        }
      });

      const token = localStorage.getItem("token");
      const authSection = document.getElementById("auth-section");
      
      // Check if Admin or Manager is logged in
      const isAdmin = sessionStorage.getItem('isAdmin') === 'true';
      const isManager = sessionStorage.getItem('isManager') === 'true';

      if (isAdmin) {
        // Admin special navbar
        authSection.innerHTML = `
          <div class="flex items-center gap-4">
             <a href="/admin.html" class="flex items-center gap-2 bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg font-semibold transition shadow-lg">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" /></svg>
                Admin Panel
             </a>
             <div class="flex items-center gap-2 px-3 py-2 bg-amber-100 dark:bg-amber-900/30 rounded-lg">
                <span class="text-xs font-bold text-amber-700 dark:text-amber-300 uppercase">GOLD LICENSE</span>
             </div>
          </div>
        `;
      } else if (isManager) {
        // Manager special navbar
        authSection.innerHTML = `
          <div class="flex items-center gap-4">
             <a href="/manager.html" class="flex items-center gap-2 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold transition shadow-lg">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" /></svg>
                Manager Panel
             </a>
             <div class="flex items-center gap-2 px-3 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg">
                <span class="text-xs font-bold text-gray-600 dark:text-gray-300 uppercase">SILVER LICENSE</span>
             </div>
          </div>
        `;
      } else if (token) {
        // Check if regular user is promoted to manager
        checkUserManagerAndSetNavbar(authSection);
      } else {
        authSection.innerHTML = `
          <div class="flex items-center gap-3">
             <a href="/login.html" class="font-display font-medium text-gray-600 dark:text-gray-300 hover:text-black dark:hover:text-white uppercase tracking-wide transition text-sm">Log In</a>
             <a href="/signup.html" class="font-display bg-black dark:bg-gray-700 text-white px-6 py-2.5 uppercase tracking-wide text-sm font-medium hover:bg-gray-800 dark:hover:bg-gray-600 transition shadow-lg rounded-sm">Sign Up</a>
          </div>
        `;
      }
    });

    async function loadProfilePhoto() {
      const userId = parseInt(localStorage.getItem("user_id"));
      if (!userId || isNaN(userId)) return;
      try {
        const res = await fetch(`/auth/profile?user_id=${userId}`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem("token")}` }
        });
        if (res.ok) {
           const data = await res.json();
           if(data.profile_photo_path) {
              const timestamp = new Date().getTime();
              document.getElementById('profileIcon').src = data.profile_photo_path + '?t=' + timestamp;
           }
        }
      } catch (err) {}
    }

    // Check if regular user is promoted to manager
    async function checkUserManagerAndSetNavbar(authSection) {
      const userId = parseInt(localStorage.getItem("user_id"));
      if (!userId || isNaN(userId)) {
        // Not logged in - show regular user navbar then check profile
        showRegularUserNavbar(authSection);
        return;
      }
      try {
        const res = await fetch(`/auth/profile?user_id=${userId}`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem("token")}` }
        });
        if (res.ok) {
          const data = await res.json();
          if (data.is_manager) {
            // User is promoted to manager - show manager navbar
            sessionStorage.setItem('isUserManager', 'true');
            authSection.innerHTML = `
              <div class="flex items-center gap-4">
                <a href="/" class="flex items-center gap-2 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold transition shadow-lg">
                  <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" /></svg>
                  Dashboard
                </a>
                <div class="flex items-center gap-2 px-3 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg">
                  <span class="text-xs font-bold text-gray-600 dark:text-gray-300 uppercase">SILVER LICENSE</span>
                </div>
              </div>
            `;
          } else {
            // Regular user - show standard navbar
            showRegularUserNavbar(authSection);
            loadProfilePhoto();
          }
        } else {
          showRegularUserNavbar(authSection);
          loadProfilePhoto();
        }
      } catch (err) {
        showRegularUserNavbar(authSection);
        loadProfilePhoto();
      }
    }

    function showRegularUserNavbar(authSection) {
      authSection.innerHTML = `
        <div class="flex items-center gap-4">
           <div class="text-right hidden sm:block">
              <div class="text-[10px] text-gray-500 dark:text-gray-400 font-bold uppercase tracking-wider">Operator</div>
              <div class="text-sm font-bold text-gray-900 dark:text-gray-100 font-display uppercase tracking-wide">Engineer</div>
           </div>
           <img id="profileIcon" src="${DEFAULT_AVATAR}" class="w-10 h-10 rounded-lg border-2 border-gray-200 dark:border-gray-600 cursor-pointer hover:border-black dark:hover:border-white transition" onclick="window.location.href='/profile.html'">
           <button onclick="logout()" class="ml-2 text-gray-400 hover:text-red-600 dark:text-gray-500 dark:hover:text-red-400 transition p-2 border-l border-gray-200 dark:border-gray-600 pl-4">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
           </button>
        </div>
      `;
    }

    function logout() {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = "/login.html";
    }

    function checkAccess(event, url) {
      event.preventDefault();
      
      // BYPASS for Admin/Manager - they have special access
      const isAdmin = sessionStorage.getItem('isAdmin') === 'true';
      const isManager = sessionStorage.getItem('isManager') === 'true';
      const isUserManager = sessionStorage.getItem('isUserManager') === 'true';
      
      if (isAdmin || isManager || isUserManager) {
          console.log('Admin/Manager/UserManager access - Full access granted');
          window.location.href = url;
          return;
      }
      
      const token = localStorage.getItem("token");
      const isLicenseActive = localStorage.getItem("is_license_active") === "true";

      if (!token) {
        window.location.href = "/login.html";
        return;
      }
      if (!isLicenseActive) {
        window.location.href = "/profile.html";
        return;
      }
      window.location.href = url;
    }
  </script>
</head>

<body class="bg-page dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans border-t-4 border-brand flex flex-col min-h-screen">
  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <nav class="bg-surface dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 h-20 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-6 h-full flex justify-between items-center">
        <a href="/" class="flex items-center gap-3 group">
            <img src="/app/assets/images/logo.png" alt="Premnath Engineering" class="w-[150px] md:w-[200px] h-[34px] md:h-[45px] rounded group-hover:scale-105 transition shadow-sm" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="w-[150px] md:w-[200px] h-[34px] md:h-[45px] bg-black text-white hidden items-center justify-center font-display font-bold text-xl rounded group-hover:bg-brand transition shadow-sm">P</div>
        </a>
        
        <div class="flex items-center gap-4">
             <button id="theme-toggle" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 transition">
                <svg id="sun-icon" class="w-5 h-5 text-gray-800 dark:text-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <svg id="moon-icon" class="w-5 h-5 text-gray-800 dark:text-gray-200 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
            
            <div id="auth-section"></div>
        </div>
    </div>
  </nav>

  <div class="bg-surface dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
      <div class="px-6 py-10 max-w-7xl mx-auto">
          <div class="flex flex-col md:flex-row justify-between items-center">
              <div>
                  <h2 class="font-display text-3xl md:text-4xl font-medium text-gray-900 dark:text-gray-100 tracking-tight uppercase">Vehicle Performance Calculator</h2>
              </div>
              <div class="flex gap-2 mt-4 md:mt-0">
                  <a href="/" class="text-sm font-semibold text-gray-500 hover:text-black dark:hover:text-white transition">Dashboard</a>
                  <span class="text-gray-300">/</span>
                  <span class="text-sm font-semibold text-brand">Vehicle Performance</span>
              </div>
          </div>
      </div>
  </div>

  <div id="license-overlay" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm flex justify-center items-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-2xl max-w-md w-full border border-gray-200 dark:border-gray-700">
      <div class="text-center mb-6">
          <div class="w-16 h-16 bg-red-100 dark:bg-red-900/30 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
          </div>
          <h2 class="text-2xl font-display font-bold text-gray-900 dark:text-gray-100">Activation Required</h2>
          <p class="text-gray-500 dark:text-gray-400 text-sm mt-2">Enter your license key to unlock the calculation engine.</p>
      </div>
      <input type="text" id="license-key-input" class="w-full p-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg mb-4 text-center font-mono tracking-widest focus:ring-2 focus:ring-brand focus:border-brand outline-none" placeholder="XXXX-XXXX-XXXX">
      <button id="license-submit-btn" class="w-full bg-brand hover:bg-blue-800 text-white font-bold py-3 px-4 rounded-lg transition duration-200 uppercase tracking-wide text-sm">
        Activate Session
      </button>
      <p id="license-error" class="text-red-500 text-xs mt-3 text-center hidden font-bold">Invalid License Key</p>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <main class="flex-grow py-12 px-6">
    <div class="max-w-7xl mx-auto">
        <!-- Three Column Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            
            <!-- Vehicle Data -->
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm border border-gray-200 dark:border-gray-700">
                <div class="border-l-4 border-green-600 pl-4">
                    <h3 class="font-display text-lg font-medium text-gray-900 dark:text-gray-100 mb-4 uppercase tracking-wide">Vehicle Data</h3>
                    <div class="grid grid-cols-1 gap-3">
                        <div><label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Weight (t)</label><input class="input-field" id="weight" value="18.500" data-export-key="weight" data-export-section="vehicle" /></div>
                        <div><label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Axles (No)</label><input class="input-field" id="axles" value="2" data-export-key="axles" data-export-section="vehicle" /></div>
                        <div id="target_speed_label"><label class="text-xs font-bold text-brand mb-1 block">Target Speed (km/h)</label><input class="input-field border-brand/50 bg-blue-50/50 dark:bg-blue-900/10" id="speed" value="35" data-export-key="speed" data-export-section="vehicle" /></div>
                        <div><label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Max RPM</label><input class="input-field" id="vehicle_rpm" value="2700" data-export-key="vehicle_rpm" data-export-section="vehicle" /></div>
                        <div><label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">PTO Ratio</label><input class="input-field" id="pto_ratio" value="1" data-export-key="pto_ratio" data-export-section="vehicle" /></div>
                        <div><label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Eng. Box Ratio</label><input class="input-field" id="engine_ratio" value="3.5" data-export-key="engine_ratio" data-export-section="vehicle" /></div>
                        <div><label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Axle Box Ratio</label><input class="input-field" id="axle_ratio" value="5.1" data-export-key="axle_ratio" data-export-section="vehicle" /></div>
                    </div>
                </div>
            </div>
            
            <!-- Track Parameters -->
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm border border-gray-200 dark:border-gray-700">
                <div class="border-l-4 border-blue-600 pl-4">
                    <h3 class="font-display text-lg font-medium text-gray-900 dark:text-gray-100 mb-4 uppercase tracking-wide">Track Parameters</h3>
                    <div class="grid grid-cols-1 gap-3">
                        <div><label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Slope (%)</label><input class="input-field" id="slope" value="0.0" data-export-key="slope" data-export-section="track" /></div>
                        <div><label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Curve (Â°)</label><input class="input-field" id="curve" value="0.0" data-export-key="curve" data-export-section="track" /></div>
                        <div><label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Wheel (mm)</label><input class="input-field" id="wheel_dia" value="560" data-export-key="wheel_dia" data-export-section="track" /></div>
                    </div>
                </div>
            </div>
            
            <!-- RRV Data -->
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm border border-gray-200 dark:border-gray-700">
                <div class="border-l-4 border-indigo-600 pl-4">
                    <h3 class="font-display text-lg font-medium text-gray-900 dark:text-gray-100 mb-4 uppercase tracking-wide">RRV Data</h3>
                    <div class="grid grid-cols-1 gap-3">
                        <div><label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Peak Power (kW)</label><input class="input-field" id="peak_power" value="90" data-export-key="peak_power_kw" data-export-section="rrv" /></div>
                        <div><label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Coeff. of Friction (Î¼)</label><input class="input-field" id="friction_mu" value="0.3" data-export-key="friction_mu" data-export-section="rrv" /></div>
                        <div><label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Wheel Dia (m)</label><input class="input-field" id="wheel_dia_meters" value="0.73" data-export-key="wheel_dia_m" data-export-section="rrv" /></div>
                        <div><label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Min RPM</label><input class="input-field" id="min_rpm" value="100" data-export-key="min_rpm" data-export-section="rrv" /></div>
                        <div><label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Max RPM</label><input class="input-field" id="max_rpm" value="2500" data-export-key="max_rpm" data-export-section="rrv" /></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Sections -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Track Data -->
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm border border-gray-200 dark:border-gray-700">
                <div class="border-l-4 border-green-600 pl-4">
                    <h3 class="font-display text-lg font-medium text-gray-900 dark:text-gray-100 mb-4 uppercase tracking-wide">Track Data</h3>
                    <div class="grid grid-cols-1 gap-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Max Curve</label><input class="input-field" id="max_curve" value="5" type="number" data-export-key="max_curve" data-export-section="track" /></div>
                            <div><label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Unit</label><select id="curve_unit" class="input-field" data-export-key="curve_unit" data-export-section="track"><option value="degree">degree</option><option value="m">m (radius)</option></select></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Max Slope</label><input class="input-field" id="max_slope" value="3.5" type="number" data-export-key="max_slope" data-export-section="track" /></div>
                            <div><label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Unit</label><select id="slope_unit" class="input-field" data-export-key="slope_unit" data-export-section="track"><option value="%">%</option><option value="degree">degree</option></select></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Vehicle Extended Data -->
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm border border-gray-200 dark:border-gray-700">
                <div class="border-l-4 border-blue-600 pl-4">
                    <h3 class="font-display text-lg font-medium text-gray-900 dark:text-gray-100 mb-4 uppercase tracking-wide">Vehicle Extended Data</h3>
                    <div class="grid grid-cols-1 gap-3">
                        <div><label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Loco GVW (kg)</label><input class="input-field" id="loco_gvw" value="11000" type="number" data-export-key="loco_gvw" data-export-section="vehicle" /></div>
                        <div><label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Max Speed (km/h)</label><input class="input-field" id="max_speed" value="60" type="number" data-export-key="max_speed" data-export-section="vehicle" /></div>
                        <div><label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Number of Axles</label><input class="input-field" id="num_axles" value="2" type="number" data-export-key="num_axles" data-export-section="vehicle" /></div>
                        <div><label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Rear Axle Ratio</label><input class="input-field" id="rear_axle_ratio" value="1.0" type="number" data-export-key="rear_axle_ratio" data-export-section="vehicle" /></div>
                        <div><label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Gear Ratios (comma-sep)</label><input class="input-field" id="gear_ratios" value="15" type="text" data-export-key="gear_ratios" data-export-section="vehicle" /></div>
                        <div><label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Shunting Load (tons)</label><input class="input-field" id="shunting_load" value="0" type="number" data-export-key="shunting_load" data-export-section="vehicle" /></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Torque Curve & Results Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Torque Curve -->
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm border border-gray-200 dark:border-gray-700">
                <div class="border-l-4 border-purple-600 pl-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-display text-lg font-medium text-gray-900 dark:text-gray-100 uppercase tracking-wide">Torque Curve</h3>
                        <div class="flex gap-2">
                            <button id="importTorqueBtn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-md text-xs font-semibold transition">Import</button>
                            <button id="exportTorqueBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-md text-xs font-semibold transition">Export</button>
                        </div>
                    </div>
                    <div class="overflow-auto max-h-60 border border-gray-200 dark:border-gray-600 rounded">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0">
                                <tr>
                                    <th class="font-semibold p-2 text-left text-gray-700 dark:text-gray-300">RPM</th>
                                    <th class="font-semibold p-2 text-left text-gray-700 dark:text-gray-300">Torque (Nm)</th>
                                    <th class="w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="torque_table_body" class="divide-y divide-gray-200 dark:divide-gray-700">
                            </tbody>
                        </table>
                    </div>
                    <button id="addTorqueRowBtn" class="mt-3 w-full text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-900 dark:text-gray-100 py-2 rounded-md font-semibold transition">
                        + Add Row
                    </button>
                </div>
            </div>
            
            <!-- Traction Snapshot -->
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm border border-gray-200 dark:border-gray-700">
                <div class="border-l-4 border-red-600 pl-4">
                    <h3 class="font-display text-lg font-medium text-gray-900 dark:text-gray-100 mb-4 uppercase tracking-wide">Traction Snapshot</h3>
                    <div class="grid grid-cols-1 gap-3">
                        <div>
                            <label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Max Traction Produced:</label>
                            <span id="res_traction_produced" class="text-sm font-semibold text-gray-900 dark:text-gray-100">- N</span>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Max Traction (No Slip):</label>
                            <span id="res_traction_slipping" class="text-sm font-semibold text-gray-900 dark:text-gray-100">- N</span>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">Result:</label>
                            <span id="res_traction_result" class="text-base font-bold text-gray-500 dark:text-gray-400">N/A</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm border border-gray-200 dark:border-gray-700 mb-6">
            <div class="border-l-4 border-gray-600 pl-4">
                <h3 class="font-display text-lg font-medium text-gray-900 dark:text-gray-100 mb-4 uppercase tracking-wide">Actions</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <button id="calculateBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-md font-semibold text-base transition">
                        ðŸ“Š Calculate Performance
                    </button>
                    <button id="saveDocBtn" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-md font-semibold text-base transition">
                        ðŸ’¾ Save Document
                    </button>
                    <button id="historyBtn" onclick="openHistoryModal()" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-md font-semibold text-base transition">
                        ðŸ•’ History
                    </button>
                </div>
            </div>
        </div>
        <pre id="errorBox" class="bg-red-50 dark:bg-red-900/20 p-4 rounded-lg text-sm font-mono whitespace-pre-wrap text-red-700 dark:text-red-400 hidden mb-6 border border-red-200 dark:border-red-800"></pre>
        <!-- Results Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Speed vs Slope Table -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                <div class="bg-gray-800 dark:bg-gray-700 text-white px-4 py-3">
                    <span class="font-semibold">Speed vs. Slope Table</span>
                </div>
                <div class="overflow-auto max-h-96">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0">
                            <tr>
                                <th class="font-semibold p-2 text-left text-xs text-gray-700 dark:text-gray-300">Slope (%)</th>
                                <th class="font-semibold p-2 text-left text-xs text-gray-700 dark:text-gray-300">Max Speed (km/h)</th>
                            </tr>
                        </thead>
                        <tbody id="speed_slope_table_body" class="divide-y divide-gray-200 dark:divide-gray-700">
                            <tr><td colspan="2" class="p-4 text-center text-gray-500 dark:text-gray-400">Click Calculate</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Charts Column -->
            <div class="lg:col-span-2 flex flex-col gap-6">
                <!-- Tractive Effort Chart -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                    <div class="bg-gray-800 dark:bg-gray-700 text-white px-4 py-3">
                        <span class="font-semibold">Tractive Effort vs. Speed</span>
                    </div>
                    <div class="p-4">
                        <div class="h-[40vh]">
                            <canvas id="teChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Shunting Capability Chart -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                    <div class="bg-gray-800 dark:bg-gray-700 text-white px-4 py-3">
                        <span class="font-semibold">Shunting Capability vs. Speed</span>
                    </div>
                    <div class="p-4">
                        <div class="h-[40vh]">
                            <canvas id="scChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>

  <script>
    let lastInputData = null;
    
    // API URL Blank for automatic detection (Render friendly)
    const API_URL = window.location.origin; 
    
    // --- Chart.js Instances ---
    let teChartInstance = null;
    let scChartInstance = null;

    // --- TOAST FUNCTION ---
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      const icons = { success: 'âœ“', error: 'âœ•', warning: 'âš ', info: 'â„¹' };
      toast.innerHTML = `<span>${icons[type] || 'â„¹'}</span><span>${message}</span>`;
      container.appendChild(toast);
      setTimeout(() => { toast.style.animation = 'slideOut 0.3s ease forwards'; setTimeout(() => toast.remove(), 300); }, 3000);
    }

    // --- DOM Elements ---
    const errorBox = document.getElementById('errorBox');
    const torqueTableBody = document.getElementById('torque_table_body');
    const addTorqueRowBtn = document.getElementById('addTorqueRowBtn');
    const csvFileInput = document.getElementById('csvFileInput');
    
    // Result spans
    const resTractionProduced = document.getElementById('res_traction_produced');
    const resTractionSlipping = document.getElementById('res_traction_slipping');
    const resTractionResult = document.getElementById('res_traction_result');
    
    // Result tables
    const speedSlopeTableBody = document.getElementById('speed_slope_table_body');

    // --- Torque Table Management ---
    function addTorqueRow(rpm = "", torque = "") {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="p-1"><input type="number" class="input torque-rpm" value="${rpm}" placeholder="RPM"></td>
            <td class="p-1"><input type="number" class="input torque-val" value="${torque}" placeholder="Torque"></td>
            <td class="p-1"><button class="text-red-500 hover:text-red-700 font-bold" onclick="removeTorqueRow(this)">Ã—</button></td>
        `;
        torqueTableBody.appendChild(row);
    }

    function removeTorqueRow(button) {
        button.closest('tr').remove();
    }

    function collectTorqueCurve() {
        const curve = {};
        const rpmInputs = document.querySelectorAll('.torque-rpm');
        const valInputs = document.querySelectorAll('.torque-val');
        
        for (let i = 0; i < rpmInputs.length; i++) {
            const rpm = parseInt(rpmInputs[i].value, 10);
            const torque = parseFloat(valInputs[i].value);
            if (!isNaN(rpm) && !isNaN(torque) && rpm > 0) {
                curve[rpm] = torque;
            }
        }
        return curve;
    }

    function populateTorqueTable(torqueData) {
        torqueTableBody.innerHTML = ""; // Clear existing
        if (!torqueData) return;
        
        // Handle both object {rpm: torque} and array [[rpm, torque], ...]
        let entries = [];
        if (Array.isArray(torqueData)) {
            entries = torqueData; // Assumes [rpm, torque]
        } else {
            entries = Object.entries(torqueData); // Converts {rpm: torque} to [[rpm, torque], ...]
        }
        
        entries.sort((a, b) => a[0] - b[0]); // Sort by RPM
        entries.forEach(([rpm, torque]) => {
            addTorqueRow(rpm, torque);
        });
    }
    
    // --- Function to collect all input data ---
    function collectRawData() {
        const rawData = { torque_curve: collectTorqueCurve() };
        // Collect all inputs with data-export-key
        document.querySelectorAll('[data-export-key]').forEach(el => {
            // Use the element's ID as the key
            rawData[el.id] = el.value;
        });
        return rawData;
    }
    
    // --- Clear Results ---
    function clearResults() {
        errorBox.textContent = "";
        errorBox.classList.add('hidden');
        resTractionProduced.textContent = "- N";
        resTractionSlipping.textContent = "- N";
        resTractionResult.textContent = "N/A";
        resTractionResult.className = "font-bold text-lg text-gray-500";
        speedSlopeTableBody.innerHTML = `<tr><td colspan="2" class="p-4 text-center text-gray-500">N/A</td></tr>`;
        
        if (teChartInstance) teChartInstance.destroy();
        if (scChartInstance) scChartInstance.destroy();
        teChartInstance = null;
        scChartInstance = null;
    }
    
    // --- API Call Function ---
    async function handleCalculateClick() {
      clearResults();
      const calculateBtn = document.getElementById('calculateBtn');
      calculateBtn.textContent = "Calculating...";
      calculateBtn.disabled = true;

      const rawData = collectRawData();

      try {
        const response = await fetch(`${API_URL}/calculate_performance`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(rawData),
        });

        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.detail || "Unknown error");
        }

        // --- Update UI with new data ---
        
        // 1. Traction Snapshot
        const snapshot = data.traction_snapshot;
        resTractionProduced.textContent = `${snapshot.max_traction_generated_n.toFixed(2)} N`;
        resTractionSlipping.textContent = `${snapshot.max_traction_slipping_n.toFixed(2)} N`;
        resTractionResult.textContent = snapshot.result_message;
        resTractionResult.className = snapshot.result_message === "Limited by slipping" 
            ? "font-bold text-lg text-red-600" 
            : "font-bold text-lg text-green-600";

        // 2. Speed vs. Slope Table
        speedSlopeTableBody.innerHTML = ""; // Clear
        data.speed_vs_slope_table.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="p-2">${row.slope.toFixed(2)}</td>
                <td class="p-2">${row.max_speed_kmh.toFixed(2)}</td>
            `;
            speedSlopeTableBody.appendChild(tr);
        });

        // 3. Tractive Effort Graph
        teChartInstance = renderPlot('teChart', data.tractive_effort_graph, 'Speed (km/h)', 'Tractive Effort (N)');
        
        // 4. Shunting Capability Graph
        scChartInstance = renderPlot('scChart', data.shunting_capability_graph, 'Speed (km/h)', 'Shunting Capability (tons)');

        lastInputData = rawData;

        // Prompt user for calculation name before saving
        promptSaveCalculation(rawData, data);

      } catch (error) {
        console.error("Fetch Error:", error);
        errorBox.textContent = `--- ERROR ---\n${error.message}`;
        errorBox.classList.remove('hidden');
        lastInputData = null;
      } finally {
        calculateBtn.textContent = "ðŸ“Š CALCULATE PERFORMANCE";
        calculateBtn.disabled = false;
      }
    }
    
    // --- Chart.js Rendering Function ---
    function renderPlot(canvasId, plotData, xLabel, yLabel) {
        const datasets = {};
        plotData.forEach(point => {
            const key = `Slope ${point.slope}% (Gear ${point.gear})`;
            if (!datasets[key]) {
                datasets[key] = {
                    label: key,
                    data: [],
                    borderColor: getRandomColor(point.slope),
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0
                };
            }
            datasets[key].data.push({ x: point.speed_kmh, y: point.value });
        });

        // Compute overall max value to set a sensible axis max
        const allValues = plotData.map(p => p.value || 0);
        const maxVal = allValues.length ? Math.max(...allValues) : 0;
        const suggestedYMax = maxVal > 0 ? Math.ceil(maxVal * 1.1) : undefined;

        const ctx = document.getElementById(canvasId).getContext('2d');
        return new Chart(ctx, {
            type: 'line',
            data: {
                datasets: Object.values(datasets)
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'linear',
                        title: {
                            display: true,
                            text: xLabel
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: yLabel
                        },
                        beginAtZero: true,
                        suggestedMax: suggestedYMax
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                const v = context.parsed.y;
                                const unit = (yLabel && yLabel.toLowerCase().includes('tons')) ? ' tons' : (yLabel && yLabel.toLowerCase().includes('n')) ? ' N' : '';
                                return `${context.dataset.label}: ${Number(v).toFixed(2)}${unit}`;
                            }
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    }

    const colorCache = {};
    function getRandomColor(slope) {
        if (colorCache[slope]) return colorCache[slope];
        
        let hash = 0;
        const strSlope = String(slope);
        for (let i = 0; i < strSlope.length; i++) {
            hash = strSlope.charCodeAt(i) + ((hash << 5) - hash);
        }
        let color = '#';
        for (let i = 0; i < 3; i++) {
            const value = (hash >> (i * 8)) & 0xFF;
            color += ('00' + value.toString(16)).substr(-2);
        }
        colorCache[slope] = color;
        return color;
    }

    // --- .docx download function ---
    async function handleSaveDocumentClick() {
        const saveDocBtn = document.getElementById('saveDocBtn');
        if (!lastInputData) {
            errorBox.textContent = "--- ERROR ---\nFirst, generate a successful report by clicking 'CALCULATE' button.";
            errorBox.classList.remove('hidden');
            return;
        }
        
        saveDocBtn.textContent = "Generating...";
        saveDocBtn.disabled = true;
        errorBox.classList.add('hidden');

        try {
            const response = await fetch(`${API_URL}/download_performance_report`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(lastInputData),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || "Failed to download file");
            }

            const blob = await response.blob();
            const contentDisposition = response.headers.get('content-disposition');
            let filename = "Vehicle_Performance_Report.docx"; 
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                if (filenameMatch && filenameMatch.length > 1) {
                    filename = filenameMatch[1];
                }
            }

            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            
        } catch (error) {
            console.error("Download Error:", error);
            errorBox.textContent = `--- DOCUMENT DOWNLOAD ERROR ---\n${error.message}`;
            errorBox.classList.remove('hidden');
        } finally {
            saveDocBtn.textContent = "ðŸ’¾ SAVE DOCUMENT";
            saveDocBtn.disabled = false;
        }
    }

    // --- CSV Import/Export Functions ---

    function triggerDownload(content, filename, mimeType) {
        const a = document.createElement('a');
        const blob = new Blob([content], { type: mimeType });
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function exportInputsCSV() {
        let csvContent = "section,key,value\n";
        const rows = [];
        document.querySelectorAll('[data-export-key]').forEach(el => {
            const section = el.getAttribute('data-export-section');
            const key = el.getAttribute('data-export-key');
            const id_key = el.id; 
            const value = el.value.includes(',') ? `"${el.value}"` : el.value; 
            rows.push(`${section},${id_key},${value}`);
        });
        csvContent += rows.join('\n');
        triggerDownload(csvContent, 'vehicle_inputs.csv', 'text/csv;charset=utf-8;');
    }

    function importInputsCSV() {
        csvFileInput.onchange = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const lines = text.split(/\r\n|\n/);
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i];
                    if (!line) continue;
                    const parts = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                    if (parts.length === 3) {
                        const key_from_csv = parts[1].replace(/"/g, ''); 
                        const value = parts[2].replace(/"/g, '');
                        const el = document.getElementById(key_from_csv);
                        if (el) el.value = value;
                    }
                }
            };
            reader.readAsText(file);
            csvFileInput.value = null;
        };
        csvFileInput.click();
    }

    function exportTorqueCSV() {
        let csvContent = "RPM,Torque\n";
        const torqueData = collectTorqueCurve();
        const rows = Object.entries(torqueData)
            .sort((a, b) => a[0] - b[0]) 
            .map(([rpm, torque]) => `${rpm},${torque}`);
        csvContent += rows.join('\n');
        triggerDownload(csvContent, 'torque_curve.csv', 'text/csv;charset=utf-8;');
    }

    function importTorqueCSV() {
        csvFileInput.onchange = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const lines = text.split(/\r\n|\n/);
                const newTorqueData = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i];
                    if (!line) continue;
                    const parts = line.split(',');
                    if (parts.length === 2) {
                        const rpm = parseFloat(parts[0]);
                        const torque = parseFloat(parts[1]);
                        if (!isNaN(rpm) && !isNaN(torque)) {
                            newTorqueData.push([rpm, torque]);
                        }
                    }
                }
                populateTorqueTable(newTorqueData);
            };
            reader.readAsText(file);
            csvFileInput.value = null; 
        };
        csvFileInput.click();
    }

    // --- Event Listeners ---
    document.getElementById("calculateBtn").addEventListener("click", handleCalculateClick);
    document.getElementById("saveDocBtn").addEventListener("click", handleSaveDocumentClick);
    addTorqueRowBtn.addEventListener("click", () => addTorqueRow());
    document.getElementById("exportInputsBtn").addEventListener("click", exportInputsCSV);
    document.getElementById("importInputsBtn").addEventListener("click", importInputsCSV);
    document.getElementById("exportTorqueBtn").addEventListener("click", exportTorqueCSV);
    document.getElementById("importTorqueBtn").addEventListener("click", importTorqueCSV);

    // --- Initial Setup ---
    populateTorqueTable({
        100: 500,
        500: 800,
        1000: 1000,
        1500: 1100,
        2000: 900,
        2500: 700
    });

    // --- HISTORY FUNCTIONS ---
    const TOOL_NAME = 'vehicle_performance';
    let pendingInputs = null;
    let pendingResults = null;

    async function saveCalculationToHistory(inputs, results, calcName = null) {
      const userId = localStorage.getItem('user_id');
      if (!userId) return;

      try {
        const payload = {
          user_id: parseInt(userId),
          tool_name: TOOL_NAME,
          inputs: inputs,
          results: results
        };
        if (calcName) {
          payload.calculation_name = calcName;
        }
        await fetch(`${API_URL}/history/save`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } catch (err) {
        console.error('Failed to save history:', err);
      }
    }

    function promptSaveCalculation(inputs, results) {
      pendingInputs = inputs;
      pendingResults = results;
      document.getElementById('calculationNameInput').value = '';
      document.getElementById('saveNameModal').classList.remove('hidden');
    }

    function skipSaveName() {
      document.getElementById('saveNameModal').classList.add('hidden');
      if (pendingInputs && pendingResults) {
        saveCalculationToHistory(pendingInputs, pendingResults);
        showToast('Calculation saved to history', 'success');
      }
      pendingInputs = null;
      pendingResults = null;
    }

    function confirmSaveName() {
      const name = document.getElementById('calculationNameInput').value.trim();
      document.getElementById('saveNameModal').classList.add('hidden');
      if (pendingInputs && pendingResults) {
        saveCalculationToHistory(pendingInputs, pendingResults, name || null);
        showToast(name ? `Saved as "${name}"` : 'Calculation saved to history', 'success');
      }
      pendingInputs = null;
      pendingResults = null;
    }

    async function openHistoryModal() {
      document.getElementById('historyModal').classList.remove('hidden');
      const historyList = document.getElementById('historyList');
      historyList.innerHTML = '<div class="text-center text-gray-500 py-8">Loading history...</div>';

      const userId = localStorage.getItem('user_id');
      if (!userId) {
        historyList.innerHTML = '<div class="text-center text-red-500 py-8">Please login to view history</div>';
        return;
      }

      try {
        const res = await fetch(`${API_URL}/history/list?user_id=${userId}&tool_name=${TOOL_NAME}`);
        const data = await res.json();

        if (data.length === 0) {
          historyList.innerHTML = '<div class="text-center text-gray-500 py-8">No calculations saved yet</div>';
          return;
        }

        historyList.innerHTML = data.map(item => {
          const inp = item.inputs || {};
          const preview = `Mass: ${inp.vehicle_mass || '-'} kg | Wheel Dia: ${inp.wheel_diameter || '-'} mm | Gear Ratio: ${inp.gear_ratio || '-'}`;
          const escapedName = (item.calculation_name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
          return `
          <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-purple-50 dark:hover:bg-purple-900/30 transition border border-gray-200 dark:border-gray-600 hover:border-purple-400">
            <div class="flex justify-between items-center">
              <div class="flex-1 cursor-pointer" onclick="loadCalculation(${item.id})">
                <h4 class="font-semibold text-gray-900 dark:text-gray-100">${item.calculation_name}</h4>
                <p class="text-xs text-blue-600 dark:text-blue-400 mt-1">${preview}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${item.created_at}</p>
              </div>
              <div class="flex items-center gap-2">
                <button onclick="event.stopPropagation(); openRenameHistoryModal(${item.id}, '${escapedName}')" class="p-2 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/30 text-blue-600 transition" title="Rename">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                </button>
                <button onclick="event.stopPropagation(); loadCalculation(${item.id})" class="p-2 rounded-lg hover:bg-purple-100 dark:hover:bg-purple-900/30 text-purple-600 transition" title="Load">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
              </div>
            </div>
          </div>
        `}).join('');

      } catch (err) {
        historyList.innerHTML = '<div class="text-center text-red-500 py-8">Failed to load history</div>';
      }
    }

    function closeHistoryModal() {
      document.getElementById('historyModal').classList.add('hidden');
    }

    // Rename history item functions
    function openRenameHistoryModal(calcId, currentName) {
      document.getElementById('renameHistoryId').value = calcId;
      document.getElementById('renameHistoryInput').value = currentName;
      document.getElementById('renameHistoryModal').classList.remove('hidden');
      document.getElementById('renameHistoryInput').focus();
      document.getElementById('renameHistoryInput').select();
    }

    function closeRenameHistoryModal() {
      document.getElementById('renameHistoryModal').classList.add('hidden');
      document.getElementById('renameHistoryId').value = '';
      document.getElementById('renameHistoryInput').value = '';
    }

    async function submitRenameHistory() {
      const calcId = document.getElementById('renameHistoryId').value;
      const newName = document.getElementById('renameHistoryInput').value.trim();

      if (!newName) {
        showToast('Please enter a name', 'warning');
        return;
      }

      try {
        const res = await fetch(`/history/rename/${calcId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ calculation_name: newName })
        });

        if (res.ok) {
          showToast('Calculation renamed successfully!', 'success');
          closeRenameHistoryModal();
          openHistoryModal();
        } else {
          const err = await res.json();
          showToast(err.detail || 'Failed to rename', 'error');
        }
      } catch (err) {
        console.error('Rename error:', err);
        showToast('Failed to rename calculation', 'error');
      }
    }

    async function loadCalculation(calcId) {
      try {
        const res = await fetch(`${API_URL}/history/detail/${calcId}`);
        const data = await res.json();

        // Fill form with saved inputs
        const inputs = data.inputs;
        
        // Fill all data-export-key inputs
        Object.entries(inputs).forEach(([key, value]) => {
          const el = document.getElementById(key);
          if (el && key !== 'torque_curve') el.value = value;
        });

        // Fill torque curve table
        if (inputs.torque_curve) {
          populateTorqueTable(inputs.torque_curve);
        }

        // Show saved results if available
        if (data.results) {
          const results = data.results;
          
          // Traction Snapshot
          if (results.traction_snapshot) {
            const snapshot = results.traction_snapshot;
            resTractionProduced.textContent = `${snapshot.max_traction_generated_n?.toFixed(2) || '-'} N`;
            resTractionSlipping.textContent = `${snapshot.max_traction_slipping_n?.toFixed(2) || '-'} N`;
            resTractionResult.textContent = snapshot.result_message || 'N/A';
            resTractionResult.className = snapshot.result_message === "Limited by slipping" 
                ? "font-bold text-lg text-red-600" 
                : "font-bold text-lg text-green-600";
          }

          // Speed vs Slope Table
          if (results.speed_vs_slope_table) {
            speedSlopeTableBody.innerHTML = "";
            results.speed_vs_slope_table.forEach(row => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td class="p-2">${row.slope?.toFixed(2) || '-'}</td>
                <td class="p-2">${row.max_speed_kmh?.toFixed(2) || '-'}</td>
              `;
              speedSlopeTableBody.appendChild(tr);
            });
          }

          // Charts
          if (results.tractive_effort_graph) {
            if (teChartInstance) teChartInstance.destroy();
            teChartInstance = renderPlot('teChart', results.tractive_effort_graph, 'Speed (km/h)', 'Tractive Effort (N)');
          }
          if (results.shunting_capability_graph) {
            if (scChartInstance) scChartInstance.destroy();
            scChartInstance = renderPlot('scChart', results.shunting_capability_graph, 'Speed (km/h)', 'Shunting Capability (tons)');
          }
        }

        lastInputData = inputs;
        closeHistoryModal();

      } catch (err) {
        console.error('Failed to load calculation:', err);
      }
    }
  </script>

  <style>
    .input { border: 1px solid #cbd5e1; border-radius: 6px; padding: 6px; width: 100%; margin-top: 4px; }
    .input:disabled { background-color: #f3f4f6; color: #9ca3af; }
  </style>
  </main>

  <!-- Save Calculation Name Modal -->
  <div id="saveNameModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md border border-gray-200 dark:border-gray-700">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-xl font-display font-bold text-gray-900 dark:text-gray-100">Save Calculation</h3>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Give your calculation a name for easy reference</p>
      </div>
      <div class="p-6">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Calculation Name</label>
        <input type="text" id="calculationNameInput" class="input-field" placeholder="e.g., EN-20 Vehicle Performance" maxlength="100">
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Leave empty for auto-generated name</p>
      </div>
      <div class="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
        <button onclick="skipSaveName()" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition">
          Skip
        </button>
        <button onclick="confirmSaveName()" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition">
          Save
        </button>
      </div>
    </div>
  </div>

  <!-- History Modal -->
  <div id="historyModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col border border-gray-200 dark:border-gray-700">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
        <div>
          <h3 class="text-xl font-display font-bold text-gray-900 dark:text-gray-100">Calculation History</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400">Click on any calculation to load it</p>
        </div>
        <button onclick="closeHistoryModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 p-2">
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
      <div id="historyList" class="flex-1 overflow-y-auto p-4 space-y-2">
        <div class="text-center text-gray-500 py-8">Loading history...</div>
      </div>
    </div>
  </div>

  <!-- Rename History Item Modal -->
  <div id="renameHistoryModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md border border-gray-200 dark:border-gray-700">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
        <h3 class="text-xl font-display font-bold text-gray-900 dark:text-gray-100">Rename Calculation</h3>
        <button onclick="closeRenameHistoryModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 p-2">
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
      <div class="p-6">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">New Name</label>
        <input type="text" id="renameHistoryInput" placeholder="Enter new name (e.g., EN-20 Project)"
               class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-teal-500 focus:border-transparent outline-none transition">
        <input type="hidden" id="renameHistoryId">
        <div class="flex gap-3 mt-6">
          <button onclick="submitRenameHistory()" class="flex-1 px-4 py-3 text-sm font-medium text-white bg-teal-600 hover:bg-teal-700 rounded-lg transition">
            Save Name
          </button>
          <button onclick="closeRenameHistoryModal()" class="flex-1 px-4 py-3 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- FOOTER -->
  <footer class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 mt-auto py-8">
      <div class="px-6 flex flex-col md:flex-row justify-between items-center">
          <p class="text-xs text-gray-500 dark:text-gray-400 font-bold uppercase tracking-widest">Â© 2024 Premnath Engineering Works â€¢ All rights reserved</p>
      </div>
  </footer>
  
</body>
</html>